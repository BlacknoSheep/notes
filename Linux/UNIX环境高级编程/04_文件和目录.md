# 4.2 函数 stat、fstat、fstatat 和 lstat

- restrict 关键字用于告诉编译器在该指针的生命周期中，其指向的对象不会被别的指针所引用，便于编译器进行优化。
- stat 为一个结构体，用于保存于文件有关的信息。为避免与 stat 函数混淆，要通过`struct stat`进行使用。

# 4.4 用户 ID 和组 ID

- 执行一个程序时，默认的有效 ID 为实际 ID。
- 可以通过设置文件的设置用户ID（SUID）位或设置组ID（SGID）位来使得：当执行此文件时，将该进程的有效用户 ID（或有效组ID）暂时设置为文件所有者的用户 ID（或组 ID），原始的有效ID被备份在保持的设置用户（组）ID 中。
  - 设置该位后，通过 `ls -l`看到的结果由`rwx`变为`rws`
  - 对于目录，SUID 无用，SGID 设置后，该目录下创建的新文件的组 ID 将被设置为该目录的组 ID。

# 4.5 文件访问权限

- 在打开文件时，需要具有该文件名包含的每一个目录的执行权限。
- 读权限允许读该目录，执行权限允许通过该目录。
  - 如果只有目录`testdir`的读权限而没有执行权限，则`ls -l testdir`只能看到目录中的文件类型和文件名，对于其他信息会报错`Permission denied`。
- 在目录中创建和删除文件时，需要具有对目录的写权限和执行权限，但不需要对该文件的权限。

# 4.6 新文件和目录的所有权

在 Linux 中，若文件所在目录的设置组 ID 被设置，则新文件的组 ID 被设置为目录的组 ID；否则被设置为进程的有效组 ID。

# 4.12 文件长度

见3.6

# 4.14 文件系统

- 一个分区包含一个文件系统。

- 目录项（块）：包含某个文件的 i 节点编号和文件名等信息。普通文件一般对应一个目录项（绝对路径）。

- 每个 i 节点都有一个链接计数，其值是指向该 i 节点的目录项数。只有当链接计数减少到 0 时才能删除该文件（释放该文件占用的数据块）。
  - 删除目录项的函数为`unlink`，实际上是“解除对一个文件的链接”。

- 硬链接：创建一个目录项，指向被链接的文件的 i 节点。目录项中的 i 节点编号是对于当前文件系统而言的，因此硬链接无法链接到其他分区的文件。
  - 对目录创建硬链接可能会在文件系统中形成循环。只有超级用户才能创建指向目录的硬链接。（如果系统支持对目录创建硬链接的话，Linux一般不支持）
  - 硬链接引发的循环很难消除，可能会导致系统错误。
- 软链接（符号链接）：创建一个符号链接文件，该文件的内容是被链接的文件的完整文件名（完整路径），不会增加被链接文件的 i 节点链接计数。软链接可以跨分区。
  - 符号链接也可能出现循环，当查找路径的函数遇到这种情况时会出错返回，errno值为ELOOP。
  - 符号链接引发的循环很容易消除，使用 unlink 函数或命令即可。
  - 创建符号链接时被链接文件可以不存在。
- 在不更换文件系统的情况下为一个文件重命名时，只需要构造一个指向现有 i 节点的目录项，并删除老的目录项。文件实际内容不会移动，链接计数不会改变。
- 对于目录文件：
  - 目录是包含目录项的文件。
  - 叶目录的链接计数为 2：命名该目录的目录项（`testdir`）和该目录中的`.`项。
  - 如果目录存在子目录，子目录的`..`项也会计入目录的链接计数。


# 4.15 函数 link、linkat、unlink、unlinkat 和 remove

- 删除一个文件时，内核先检查打开该文件的进程数，如果这个数为 0，内核再检查其链接计数，如果也是 0，则删除该文件内容。

```cpp
/*
 * 打开一个文件，unlink，然后等待15s
 * unlink后文件链接计数归0，目录项被删除
 * 而文件需要等到进程结束才会真正删除（可通过磁盘剩余空间查看）
 */
#include <fcntl.h>
#include <iostream>
#include <unistd.h>
using namespace std;

int main() {
  if ((open("testfile", O_RDWR)) < 0) {
    cerr << "open error" << endl;
    exit(0);
  }
  if (unlink("testfile") < 0) {
    cerr << "unlink error" << endl;
    exit(0);
  }
  cout << "file unlinked" << endl;
  sleep(15);
  cout << "done" << endl;
  return 0;
}
```

# 4.18 创建和读取符号链接。

使用`symlink`或`symlinkat`函数创建符号链接。

使用`readlink`或`readlinkat`函数打开符号链接本身，读取内容，然后关闭。（`open`会跟随符号链接）

# 4.25 文件访问权限位小结

```
S_IRWXU = S_IRUSR | S_IWUSR | S_IXUSR
S_IRWXG = S_IRGRP | S_IWGRP | S_IXGRP
S_IRWXO = S_IROTH | S_IWOTH | S_IXOTH
```
